on:
  push:
    tags:
      - 'v*.*.*'

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'true'

    - name: Get release tag from GITHUB_REF
      id: vars
      run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}

    - name: Windows x86
      run: >
        docker run --rm --mount type=bind,src=${{github.workspace}},dest=/source taforever/ci-ubuntu-focal:latest /bin/bash -c
          mkdir -p /source/build-${{env.BUILD_TAG}} && cd /source/build-${{env.BUILD_TAG}};
          ../build-gcc.sh;
          zip gpgnet4ta-${{env.BUILD_TAG}}.zip bin/*
      env:
        BUILD_TAG: win-x86

    - name: Ubuntu Focal
      run: >
        docker run --rm --mount type=bind,src=${{github.workspace}},dest=/source taforever/ci-ubuntu-focal:latest /bin/bash -c
          mkdir -p /source/build-${{env.BUILD_TAG}} && cd /source/build-${{env.BUILD_TAG}};
          ../build-gcc.sh;
          tar -zcf gpgnet4ta-${{env.BUILD_TAG}}.tar.gz bin/*
      env:
        BUILD_TAG: ubuntu-focal-x64

    - name: Upload artifacts
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          gpgnet4ta-win-x86.zip
          gpgnet4ta-ubuntu-focal-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
